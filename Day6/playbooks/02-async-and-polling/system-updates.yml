---
- name: System Updates with Async
  hosts: servers
  become: yes
  serial: 1 # Update one server at a time

  vars:
    update_timeout: 3600 # 1 hour
    reboot_timeout: 600 # 10 minutes

  tasks:
  - name: Display update target
    debug:
      msg: |
        ================================================
        System Update Starting
        ================================================
        Host: {{ inventory_hostname }}
        Progress: {{ ansible_play_hosts.index(inventory_hostname) + 1 }}/{{ ansible_play_hosts | length }}
        Time: {{ ansible_date_time.time }}

  - name: Update package cache
    apt:
      update_cache: yes
      cache_valid_time: 600
    when: ansible_os_family == "Debian"

  - name: Check for available updates
    shell: apt list --upgradable 2>/dev/null | grep -v "Listing..." | wc -l
    register: updates_available
    changed_when: false
    when: ansible_os_family == "Debian"

  - name: Display update information
    debug:
      msg: |
        Updates available: {{ updates_available.stdout | default('Unknown') }}
        {% if updates_available.stdout | int > 0 %}
        Proceeding with system update...
        {% else %}
        System is up to date!
        {% endif %}

  - name: Perform system update (async to prevent SSH timeout)
    apt:
      upgrade: dist
      update_cache: yes
      autoremove: yes
      autoclean: yes
    async: "{{ update_timeout }}"
    poll: 60 # Check every minute
    register: update_result
    when:
    - ansible_os_family == "Debian"
    - updates_available.stdout | int > 0

  - name: Display update results
    debug:
      msg: |
        Update Results
        ==============
        Duration: {{ update_result.delta | default('N/A') }}
        Packages changed: {{ update_result.changed | default(false) }}

        {% if update_result.changed %}
        ‚úÖ System updated successfully
        {% else %}
        ‚ÑπÔ∏è  No updates applied
        {% endif %}
    when: update_result is defined

  - name: Check if reboot is required
    stat:
      path: /var/run/reboot-required
    register: reboot_required

  - name: Display reboot requirement
    debug:
      msg: |
        {% if reboot_required.stat.exists %}
        ‚ö†Ô∏è  REBOOT REQUIRED
        System will be rebooted...
        {% else %}
        ‚úÖ No reboot required
        {% endif %}

  - name: Reboot system (async to handle SSH disconnect)
    reboot:
      reboot_timeout: "{{ reboot_timeout }}"
      pre_reboot_delay: 10
      post_reboot_delay: 30
      msg: "Reboot initiated by Ansible after system update"
    async: "{{ reboot_timeout }}"
    poll: 0
    when: reboot_required.stat.exists
    register: reboot_job

  - name: Wait for system to reboot
    wait_for_connection:
      delay: 30
      timeout: "{{ reboot_timeout }}"
    when: reboot_required.stat.exists

  - name: Verify system is back online
    command: uptime
    register: uptime_result
    changed_when: false
    when: reboot_required.stat.exists

  - name: Display post-reboot status
    debug:
      msg: |
        System Rebooted Successfully
        ============================
        {{ uptime_result.stdout }}
    when:
    - reboot_required.stat.exists
    - uptime_result is defined

  - name: Verify services are running
    systemd:
      name: "{{ item }}"
      state: started
    loop:
    - ssh
    - cron
    register: services_check

  - name: Check kernel version
    command: uname -r
    register: kernel_version
    changed_when: false

  - name: Check disk space after update
    shell: df -h / | tail -1 | awk '{print $5}'
    register: disk_usage
    changed_when: false

  - name: Update completion summary
    debug:
      msg: |
        ================================================
        Update Complete for {{ inventory_hostname }}
        ================================================

        Updates Applied: {{ 'Yes' if update_result.changed | default(false) else 'No' }}
        {% if update_result is defined %}
        Update Duration: {{ update_result.delta }}
        {% endif %}

        Reboot Performed: {{ 'Yes' if reboot_required.stat.exists else 'No' }}
        {% if uptime_result is defined %}
        System Uptime: {{ uptime_result.stdout }}
        {% endif %}

        Kernel Version: {{ kernel_version.stdout }}
        Disk Usage: {{ disk_usage.stdout }}

        Services Status: All essential services running

        ‚úÖ System update completed successfully!

  - name: Save update log
    copy:
      content: |
        System Update Log
        =================
        Host: {{ inventory_hostname }}
        Date: {{ ansible_date_time.iso8601 }}

        Pre-Update Status
        -----------------
        Updates Available: {{ updates_available.stdout | default('Unknown') }}

        Update Process
        --------------
        Updates Applied: {{ 'Yes' if update_result.changed | default(false) else 'No' }}
        {% if update_result is defined %}
        Duration: {{ update_result.delta }}
        Timeout Used: {{ update_timeout }}s
        {% endif %}

        Reboot Status
        -------------
        Reboot Required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}
        {% if reboot_required.stat.exists %}
        Reboot Performed: Yes
        Reboot Duration: ~{{ reboot_timeout }}s max
        {% endif %}

        Post-Update Status
        ------------------
        Kernel Version: {{ kernel_version.stdout }}
        Disk Usage: {{ disk_usage.stdout }}
        System Uptime: {{ uptime_result.stdout | default('N/A') }}

        Notes
        -----
        - Used async execution to prevent SSH timeouts
        - Polling interval: 60 seconds
        - All critical services verified running
      dest: /var/log/ansible_update_{{ ansible_date_time.epoch }}.log
      mode: '0644'

  - name: Pause before next server
    pause:
      seconds: 30
      prompt: "Update completed for {{ inventory_hostname }}. Pausing before next server..."
    when: inventory_hostname != ansible_play_hosts[-1]

# Summary play
- name: Update Campaign Summary
  hosts: servers
  gather_facts: no
  run_once: yes

  tasks:
  - name: Overall update summary
    debug:
      msg: |
        ================================================
        SYSTEM UPDATE CAMPAIGN COMPLETED
        ================================================

        Total Servers: {{ groups['servers'] | length }}
        Strategy: Serial (one at a time)

        All servers updated successfully!

        üí° Async execution prevented SSH timeouts
        ‚ö° Polling allowed monitoring of long-running updates
        üîÑ Automatic reboots handled gracefully

        Check /var/log/ansible_update_*.log on each server for details.

# Usage:
#
# Update all servers (one at a time):
#   ansible-playbook -i inventory.ini system-updates.yml
#
# Update specific servers:
#   ansible-playbook -i inventory.ini system-updates.yml --limit "server1"
#
# Dry run (check what would be updated):
#   ansible-playbook -i inventory.ini system-updates.yml --check
#
# Update with custom timeout:
#   ansible-playbook -i inventory.ini system-updates.yml -e "update_timeout=7200"
#
# View update logs:
#   ansible servers -i inventory.ini -m shell -a "cat /var/log/ansible_update_*.log | tail -50" --become
#
# Check if reboot needed:
#   ansible servers -i inventory.ini -m stat -a "path=/var/run/reboot-required" --become
