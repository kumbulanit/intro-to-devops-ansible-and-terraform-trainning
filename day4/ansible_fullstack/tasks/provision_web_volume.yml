---
# Provision a single web tier volume
# Called via include_tasks with loop_var: web_index

- name: Set web server variables for index {{ web_index }}
  set_fact:
    current_web_name: "{{ web_prefix }}{{ web_index }}"
    current_web_volume: "{{ web_prefix }}{{ web_index }}-volume"

- name: Create volume for {{ current_web_name }}
  openstack.cloud.volume:
    cloud: "{{ cloud_name }}"
    name: "{{ current_web_volume }}"
    size: "{{ web_volume_size }}"
    image: "{{ image_name }}"
    bootable: true
    state: present
  register: web_volume_create

- name: Record volume id for {{ current_web_volume }}
  set_fact:
    current_web_volume_id: "{{ web_volume_create.volume.id | default(web_volume_create.id) }}"

- name: Wait for {{ current_web_volume }} to become ready
  openstack.cloud.volume_info:
    cloud: "{{ cloud_name }}"
    filters:
      id: "{{ current_web_volume_id }}"
  register: web_volume_status
  until: >-
    (web_volume_status.volumes is defined) and (web_volume_status.volumes | length > 0) and ((web_volume_status.volumes[0].status | default('creating')) in ['available', 'in-use', 'error'])
  retries: 30
  delay: 5
  failed_when: >-
    web_volume_status.failed | default(false) or (
      (web_volume_status.volumes is defined)
      and (web_volume_status.volumes | length > 0)
      and ((web_volume_status.volumes[0].status | default('error')) == 'error')
    )

- name: Ensure {{ current_web_volume }} is bootable
  command: "openstack volume set --bootable {{ current_web_volume_id }}"
  environment:
    OS_CLOUD: "{{ cloud_name }}"
  ignore_errors: true

- name: Cache {{ current_web_volume }} details
  set_fact:
    current_web_volume_details: >-
      {{ web_volume_status.volumes[0]
         if (web_volume_status.volumes is defined and web_volume_status.volumes | length > 0)
         else (web_volume_create.volume if (web_volume_create.volume is defined) else web_volume_create) }}

- name: Compose {{ current_web_volume }} metadata
  set_fact:
    current_web_volume_record:
      server_name: "{{ current_web_name }}"
      volume_name: "{{ current_web_volume }}"
      volume_id: "{{ current_web_volume_details.id }}"
      status: "{{ current_web_volume_details.status }}"
      bootable: "{{ current_web_volume_details.is_bootable }}"

- name: Append {{ current_web_volume }} metadata
  set_fact:
    web_volume_records: "{{ (web_volume_records | default([])) + [ current_web_volume_record ] }}"
