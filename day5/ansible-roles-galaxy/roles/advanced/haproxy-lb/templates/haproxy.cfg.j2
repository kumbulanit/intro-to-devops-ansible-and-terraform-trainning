#jinja2: lstrip_blocks: "True", trim_blocks: "True"
# HAProxy Configuration File
# Generated by Ansible - Do not edit manually
# Role: haproxy-lb

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log {{ haproxy_log_address }} {{ haproxy_log_facility }} {{ haproxy_log_level }}
    chroot /var/lib/haproxy
    pidfile /var/run/haproxy.pid
    maxconn {{ haproxy_maxconn }}
    user {{ haproxy_user }}
    group {{ haproxy_group }}
    daemon
    
    # Socket for admin commands
    stats socket {{ haproxy_socket_dir }}/haproxy.sock mode 660 level admin
    stats timeout 30s

    {% if haproxy_ssl_enabled %}
    # SSL settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    {% endif %}

    {% if haproxy_custom_global %}
    # Custom global configuration
    {{ haproxy_custom_global }}
    {% endif %}

#---------------------------------------------------------------------
# Common defaults
#---------------------------------------------------------------------
defaults
    mode http
    log global
    {% for option in haproxy_options %}
    option {{ option }}
    {% endfor %}
    
    timeout connect {{ haproxy_timeout_connect }}
    timeout client {{ haproxy_timeout_client }}
    timeout server {{ haproxy_timeout_server }}
    
    maxconn {{ haproxy_backend_maxconn }}

    {% if haproxy_compression_enabled %}
    # Enable compression
    compression algo gzip
    compression type {{ haproxy_compression_types | join(' ') }}
    {% endif %}

    {% if haproxy_custom_defaults %}
    # Custom defaults configuration
    {{ haproxy_custom_defaults }}
    {% endif %}

#---------------------------------------------------------------------
# Stats page
#---------------------------------------------------------------------
{% if haproxy_stats_enabled %}
listen stats
    bind {{ haproxy_bind_address }}:{{ haproxy_stats_port }}
    stats enable
    stats uri {{ haproxy_stats_uri }}
    stats refresh {{ haproxy_stats_refresh }}
    stats auth {{ haproxy_stats_username }}:{{ haproxy_stats_password }}
    {% if haproxy_stats_admin %}
    stats admin if TRUE
    {% endif %}
{% endif %}

#---------------------------------------------------------------------
# Frontend configuration
#---------------------------------------------------------------------
frontend {{ haproxy_frontend_name }}
    bind {{ haproxy_bind_address }}:{{ haproxy_frontend_port }}
    
    {% if haproxy_ssl_enabled %}
    bind {{ haproxy_bind_address }}:{{ haproxy_ssl_port }} ssl crt {{ haproxy_ssl_dir }}/{{ haproxy_ssl_certificate_name }}
    
    {% if haproxy_ssl_redirect_http %}
    # Redirect HTTP to HTTPS
    redirect scheme https code 301 if !{ ssl_fc }
    {% endif %}
    {% endif %}

    default_backend {{ haproxy_backend_name }}

    {% if haproxy_custom_frontend %}
    # Custom frontend configuration
    {{ haproxy_custom_frontend }}
    {% endif %}

#---------------------------------------------------------------------
# Backend configuration
#---------------------------------------------------------------------
backend {{ haproxy_backend_name }}
    balance {{ haproxy_balance_algorithm }}
    
    {% if haproxy_health_check_enabled %}
    # Health check options
    option httpchk GET /
    {% endif %}

    {% for server in haproxy_backend_servers %}
    server {{ server.name }} {{ server.address }}:{{ server.port }} \
    {% if server.check | default(haproxy_health_check_enabled) %}
        check inter {{ haproxy_health_check_interval }} \
        rise {{ haproxy_health_check_rise }} \
        fall {{ haproxy_health_check_fall }} \
    {% endif %}
    {% if server.backup | default(false) %}backup {% endif %}
    {% if server.maxconn is defined %}maxconn {{ server.maxconn }} {% endif %}
    {% if server.weight is defined %}weight {{ server.weight }}{% endif %}

    {% endfor %}

    {% if haproxy_custom_backend %}
    # Custom backend configuration
    {{ haproxy_custom_backend }}
    {% endif %}
