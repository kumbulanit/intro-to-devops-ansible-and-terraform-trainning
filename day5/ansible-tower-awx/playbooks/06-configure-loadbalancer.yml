---
# =============================================================================
# Configure HAProxy Load Balancer
# =============================================================================
# Description: Installs and configures HAProxy to load balance web servers
#
# Prerequisites:
#   - Load balancer VM provisioned
#   - Web servers configured
#   - Inventory file exists
#
# Usage:
#   ansible-playbook 06-configure-loadbalancer.yml -i inventories/production/hosts
# =============================================================================

- name: Configure HAProxy Load Balancer
  hosts: loadbalancers
  become: true
  gather_facts: true
  
  vars:
    haproxy_stats_user: admin
    haproxy_stats_password: "HAProxyStatsPassword123!"

  tasks:
    # =========================================================================
    # PHASE 1: Install HAProxy
    # =========================================================================
    
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install HAProxy
      apt:
        name:
          - haproxy
          - hatop
        state: present

    # =========================================================================
    # PHASE 2: Configure HAProxy
    # =========================================================================

    - name: Backup original HAProxy configuration
      copy:
        src: /etc/haproxy/haproxy.cfg
        dest: /etc/haproxy/haproxy.cfg.backup
        remote_src: true
        force: false

    - name: Configure HAProxy
      copy:
        dest: /etc/haproxy/haproxy.cfg
        mode: '0644'
        backup: true
        content: |
          # HAProxy Configuration for Three-Tier Application
          # Generated by Ansible
          
          global
              log /dev/log    local0
              log /dev/log    local1 notice
              chroot /var/lib/haproxy
              stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
              stats timeout 30s
              user haproxy
              group haproxy
              daemon
              maxconn 4096
              
              # Default SSL material locations
              ca-base /etc/ssl/certs
              crt-base /etc/ssl/private
              
              # SSL/TLS configuration
              ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
              ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
          
          defaults
              log     global
              mode    http
              option  httplog
              option  dontlognull
              option  forwardfor
              option  http-server-close
              timeout connect 5000
              timeout client  50000
              timeout server  50000
              errorfile 400 /etc/haproxy/errors/400.http
              errorfile 403 /etc/haproxy/errors/403.http
              errorfile 408 /etc/haproxy/errors/408.http
              errorfile 500 /etc/haproxy/errors/500.http
              errorfile 502 /etc/haproxy/errors/502.http
              errorfile 503 /etc/haproxy/errors/503.http
              errorfile 504 /etc/haproxy/errors/504.http
          
          # Statistics page
          listen stats
              bind *:8404
              stats enable
              stats uri /stats
              stats realm HAProxy\ Statistics
              stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
              stats refresh 30s
              stats show-legends
              stats show-node
              stats admin if TRUE
          
          # Frontend configuration
          frontend http_front
              bind *:80
              mode http
              
              # Access Control Lists
              acl url_static path_end -i .jpg .jpeg .gif .png .css .js .ico
              acl url_health path_beg -i /health
              
              # Routing rules
              use_backend static_backend if url_static
              default_backend http_back
          
          # Backend configuration for web servers
          backend http_back
              mode http
              balance roundrobin
              option httpchk GET /health
              http-check expect status 200
              
              # Cookie-based persistence (optional)
              cookie SERVERID insert indirect nocache
              
              # Web servers
          {% for host in groups['webservers'] %}
              server {{ host }} {{ hostvars[host]['ansible_host'] }}:80 check cookie {{ host }} inter 2000 rise 2 fall 3
          {% endfor %}
          
          # Static content backend (same servers, different config)
          backend static_backend
              mode http
              balance roundrobin
              option httpchk GET /health
              http-check expect status 200
              
          {% for host in groups['webservers'] %}
              server {{ host }}-static {{ hostvars[host]['ansible_host'] }}:80 check inter 5000
          {% endfor %}
      notify: restart haproxy

    - name: Validate HAProxy configuration
      command: haproxy -c -f /etc/haproxy/haproxy.cfg
      register: haproxy_validation
      changed_when: false

    # =========================================================================
    # PHASE 3: Enable and Start HAProxy
    # =========================================================================

    - name: Enable HAProxy service
      systemd:
        name: haproxy
        enabled: true

    - name: Ensure HAProxy is running
      systemd:
        name: haproxy
        state: started

    # =========================================================================
    # PHASE 4: Firewall Configuration
    # =========================================================================

    - name: Install UFW
      apt:
        name: ufw
        state: present

    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Allow HTTP
      ufw:
        rule: allow
        port: '80'
        proto: tcp

    - name: Allow HTTPS
      ufw:
        rule: allow
        port: '443'
        proto: tcp

    - name: Allow HAProxy Stats
      ufw:
        rule: allow
        port: '8404'
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled

    # =========================================================================
    # PHASE 5: Create Management Scripts
    # =========================================================================

    - name: Create HAProxy management script
      copy:
        dest: /usr/local/bin/haproxy-manage
        mode: '0755'
        content: |
          #!/bin/bash
          # HAProxy Management Script
          
          case "$1" in
            status)
              systemctl status haproxy
              ;;
            reload)
              echo "Reloading HAProxy configuration..."
              systemctl reload haproxy
              ;;
            restart)
              echo "Restarting HAProxy..."
              systemctl restart haproxy
              ;;
            validate)
              echo "Validating HAProxy configuration..."
              haproxy -c -f /etc/haproxy/haproxy.cfg
              ;;
            stats)
              echo "HAProxy Statistics:"
              echo "URL: http://{{ ansible_default_ipv4.address }}:8404/stats"
              echo "Username: {{ haproxy_stats_user }}"
              echo "Password: {{ haproxy_stats_password }}"
              ;;
            backends)
              echo "Backend server status:"
              echo "show stat" | socat /run/haproxy/admin.sock stdio | grep "^http_back"
              ;;
            *)
              echo "Usage: $0 {status|reload|restart|validate|stats|backends}"
              exit 1
              ;;
          esac

    # =========================================================================
    # PHASE 6: Verification and Monitoring
    # =========================================================================

    - name: Wait for HAProxy to be ready
      wait_for:
        port: 80
        delay: 2
        timeout: 30

    - name: Test HAProxy health
      uri:
        url: "http://localhost"
        return_content: true
        status_code: 200
      register: haproxy_test
      ignore_errors: true

    - name: Get HAProxy stats
      uri:
        url: "http://localhost:8404/stats;csv"
        user: "{{ haproxy_stats_user }}"
        password: "{{ haproxy_stats_password }}"
        force_basic_auth: true
      register: haproxy_stats
      ignore_errors: true

    - name: Save load balancer information
      copy:
        dest: /root/loadbalancer-info.txt
        mode: '0600'
        content: |
          HAProxy Load Balancer Information
          ==================================
          
          Public Access:
          --------------
          Application: http://{{ ansible_default_ipv4.address }}
          Statistics: http://{{ ansible_default_ipv4.address }}:8404/stats
          
          Stats Credentials:
          ------------------
          Username: {{ haproxy_stats_user }}
          Password: {{ haproxy_stats_password }}
          
          Backend Servers:
          ----------------
          {% for host in groups['webservers'] %}
          - {{ host }}: {{ hostvars[host]['ansible_host'] }}
          {% endfor %}
          
          Management Commands:
          --------------------
          haproxy-manage status      # Check HAProxy status
          haproxy-manage reload      # Reload configuration
          haproxy-manage restart     # Restart service
          haproxy-manage validate    # Validate config
          haproxy-manage stats       # Show stats URL
          haproxy-manage backends    # Show backend status
          
          Log Files:
          ----------
          Main log: /var/log/haproxy.log
          Systemd: journalctl -u haproxy -f
          
          Configuration:
          --------------
          Config file: /etc/haproxy/haproxy.cfg
          Socket: /run/haproxy/admin.sock
          
          Health Checks:
          --------------
          Endpoint: /health on each backend server
          Interval: 2 seconds
          Rise: 2 successful checks to mark server UP
          Fall: 3 failed checks to mark server DOWN

    - name: Display load balancer status
      debug:
        msg: |
          ========================================
          HAProxy Load Balancer Configured!
          ========================================
          
          Public IP: {{ ansible_default_ipv4.address }}
          Application URL: http://{{ ansible_default_ipv4.address }}
          Statistics URL: http://{{ ansible_default_ipv4.address }}:8404/stats
          
          Stats Login:
            Username: {{ haproxy_stats_user }}
            Password: {{ haproxy_stats_password }}
          
          Backend Servers:
          {% for host in groups['webservers'] %}
            - {{ host }}: {{ hostvars[host]['ansible_host'] }}
          {% endfor %}
          
          Health Check: {{ 'OK' if haproxy_test.status == 200 else 'Check logs' }}
          
          Management: haproxy-manage {status|reload|restart|validate|stats|backends}
          ========================================

  handlers:
    - name: restart haproxy
      systemd:
        name: haproxy
        state: restarted

    - name: reload haproxy
      systemd:
        name: haproxy
        state: reloaded
